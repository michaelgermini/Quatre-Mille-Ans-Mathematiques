name: ğŸ” CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Job de validation des liens
  validate-links:
    name: ğŸ”— Validation des liens
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“¦ Install markdown-link-check
      run: npm install -g markdown-link-check
      
    - name: ğŸ” Check links in markdown files
      run: |
        find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*" | \
        xargs -I {} markdown-link-check {} --config .markdown-link-check.json

  # Job de validation du format Markdown
  validate-markdown:
    name: ğŸ“ Validation Markdown
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“¦ Install markdownlint
      run: npm install -g markdownlint-cli
      
    - name: ğŸ“ Lint markdown files
      run: markdownlint "**/*.md" --ignore node_modules --ignore .git

  # Job de validation de la structure
  validate-structure:
    name: ğŸ“ Validation de la structure
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ“ Check required directories
      run: |
        echo "VÃ©rification des rÃ©pertoires principaux..."
        test -d "00.5_Mathematiques_Mesopotamiennes" || exit 1
        test -d "00.7_Mathematiques_Mayas" || exit 1
        test -d "01_Mathematiques_Grecques" || exit 1
        test -d "02_Mathematiques_Arabes" || exit 1
        test -d "02_Cosmologie_Mathematique" || exit 1
        test -d "03_Mathematiques_Indiennes" || exit 1
        test -d "04_Mathematiques_Chinoises" || exit 1
        test -d "05_Mathematiciens_modernes" || exit 1
        test -d "06.5_Mathematiques_Japonaises" || exit 1
        test -d "Sections_Transversales" || exit 1
        echo "âœ… Tous les rÃ©pertoires principaux sont prÃ©sents"
        
    - name: ğŸ“„ Check required files
      run: |
        echo "VÃ©rification des fichiers principaux..."
        test -f "README.md" || exit 1
        test -f "LICENSE" || exit 1
        test -f "CONTRIBUTING.md" || exit 1
        test -f "07_Annexes.md" || exit 1
        echo "âœ… Tous les fichiers principaux sont prÃ©sents"

  # Job de gÃ©nÃ©ration de statistiques
  generate-stats:
    name: ğŸ“Š GÃ©nÃ©ration de statistiques
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ“Š Generate project statistics
      run: |
        echo "## ğŸ“Š Statistiques du projet" >> stats.md
        echo "" >> stats.md
        echo "### ğŸ“ Structure" >> stats.md
        echo "- **RÃ©pertoires principaux** : $(find . -maxdepth 1 -type d | wc -l)" >> stats.md
        echo "- **Fichiers Markdown** : $(find . -name "*.md" | wc -l)" >> stats.md
        echo "- **Lignes de code** : $(find . -name "*.md" -exec wc -l {} + | tail -1 | awk '{print $1}')" >> stats.md
        echo "" >> stats.md
        echo "### ğŸ“š Contenu" >> stats.md
        echo "- **Chapitres** : $(find . -maxdepth 1 -name "*_Mathematiques_*" -o -name "*_Cosmologie_*" -o -name "*_Mathematiciens_*" | wc -l)" >> stats.md
        echo "- **Sections transversales** : $(find Sections_Transversales -maxdepth 1 -type d | wc -l)" >> stats.md
        echo "- **Exercices** : $(grep -r "## Exercice" . --include="*.md" | wc -l)" >> stats.md
        echo "" >> stats.md
        echo "### ğŸŒ Couverture" >> stats.md
        echo "- **Civilisations** : MÃ©sopotamie, GrÃ¨ce, Monde arabe, Inde, Chine, Japon, Europe" >> stats.md
        echo "- **PÃ©riodes** : 4000 ans d'histoire" >> stats.md
        echo "- **Langues** : FranÃ§ais (avec possibilitÃ© de traduction)" >> stats.md
        
    - name: ğŸ“¤ Upload stats as artifact
      uses: actions/upload-artifact@v4
      with:
        name: project-stats
        path: stats.md

  # Job de dÃ©ploiement (si applicable)
  deploy:
    name: ğŸš€ DÃ©ploiement
    runs-on: ubuntu-latest
    needs: [validate-links, validate-markdown, validate-structure]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸš€ Deploy to GitHub Pages (placeholder)
      run: |
        echo "ğŸš€ DÃ©ploiement vers GitHub Pages"
        echo "Cette Ã©tape peut Ãªtre configurÃ©e pour dÃ©ployer vers GitHub Pages"
        echo "ou vers un autre service de dÃ©ploiement selon les besoins"

  # Job de notification
  notify:
    name: ğŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [validate-links, validate-markdown, validate-structure, generate-stats]
    if: always()
    
    steps:
    - name: ğŸ“¢ Notify completion
      run: |
        if [ "${{ needs.validate-links.result }}" == "success" ] && 
           [ "${{ needs.validate-markdown.result }}" == "success" ] && 
           [ "${{ needs.validate-structure.result }}" == "success" ]; then
          echo "âœ… Tous les tests ont rÃ©ussi !"
        else
          echo "âŒ Certains tests ont Ã©chouÃ©."
          exit 1
        fi
